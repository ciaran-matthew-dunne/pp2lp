require open pp2lp.B;

// statically check if a term denotes a set.
sequential symbol bSet : Exp â†’ ğ”¹;
rule bSet ($E â†¦ $F) â†ª false
with bSet (choice $E) â†ª bSet $E
with bSet ($E Ã— $F) â†ª (bSet $E) and (bSet $F)
with bSet (ğ’« $E) â†ª bSet $E
with bSet (comp $x $P) â†ª true
with bSet big â†ª true;

// datatype for B-types.
inductive bTyp : TYPE â‰”
  | super : Exp â†’ bTyp
  | typ : Exp â†’ bTyp
  | âˆ— : bTyp â†’ bTyp â†’ bTyp
  | â„™ : bTyp â†’ bTyp
  | iden : String â†’ bTyp;

// infix notation for type-level product.
notation âˆ— infix right 10;

// datatype for B-type-predicates.
inductive bTypPrd : TYPE â‰”
  | check : Prd â†’ bTypPrd
  | ty_eq : bTyp â†’ bTyp â†’ bTypPrd;

// `j : judge p` iff `j` derives the typing-predicate `p`.
constant symbol judge : bTypPrd â†’ TYPE;

// `j : âœ“ p` iff `j` derives `check p`.
symbol âœ“ (p : Prd) : TYPE â‰” judge (check p);

// `j : t â‰£ t'` iff `j` derives `ty_eq t t'`.
symbol â‰£ (t t' : bTyp) : TYPE â‰” judge (ty_eq t t');
notation â‰£ infix 5;


symbol symm [U T] : (U â‰£ T) â†’ (T â‰£ U);

symbol given : Exp â†’ TYPE;

symbol T1 [P Q : Prd]
  : âœ“ P â†’ âœ“ Q â†’ âœ“ (P âˆ§ Q);

symbol T2 [P Q : Prd]
  : âœ“ P â†’ âœ“ Q â†’ âœ“ (P â‡’ Q);

symbol T3 [P : Prd]
  : âœ“ P â†’ âœ“ (Â¬ P);

symbol T4 [x : Var] [s : Exp] [P : Prd]
  : (â–· (x âˆˆ s) â†’ âœ“ P) â†’ âœ“ (âˆ€ x (x âˆˆ s â‡’ P));

symbol T5 [x y : Var] [s t : Exp] [P : Prd]
  : âœ“ (âˆ€ x (x âˆˆ s â‡’ âˆ€ y (y âˆˆ t â‡’ P)))
  â†’ âœ“ (âˆ€ (x â¨¾ y) ((x â†¦ y) âˆˆ (s Ã— t) â‡’ P));

symbol T6 [x : Var] [P Q R : Prd]
  : âœ“ (âˆ€ x (P â‡’ Q âˆ§ R))
  â†’ âœ“ (âˆ€ x (P âˆ§ Q â‡’ R));

symbol T7 [E F : Exp]
  : (typ E â‰£ typ F) â†’ âœ“ (E = F);

symbol T8 [E s : Exp]
  : (typ E â‰£ super s) â†’ âœ“ (E âˆˆ s);

symbol T8' [s t : Exp]
  : (super s â‰£ super t) â†’ âœ“ (s âŠ† t);

symbol T9 [x : Var] [s : Exp] [U : bTyp]
  : â–· (x âˆˆ s) â†’ (super s â‰£ U) â†’ (typ x â‰£ U);

symbol T10 [E F : Exp] [U : bTyp]
  : (typ E âˆ— typ F â‰£ U) â†’ (typ (E â†¦ F) â‰£ U);

symbol T11 [s : Exp] [U : bTyp]
  : (super s â‰£ U) â†’ (typ (choice s) â‰£ U);

symbol T12 [s : Exp] [U : bTyp]
  : (â„™ (super s) â‰£ U) â†’ (typ s â‰£ U);

symbol T13 [x : Var] [s : Exp] [U : bTyp]
  : â–· (x âˆˆ s)
  â†’ (super s â‰£ â„™ U)
  â†’ (super x â‰£ U);

symbol T13' [x : Var] [s : Exp] [U : bTyp]
  : â–· (x âˆˆ s)
  â†’ (â„™ U â‰£ super s)
  â†’ (U â‰£ super x)
  â‰” Î» h1 h2, symm (T13 h1 (symm h2));

symbol T14 [s t : Exp] [U : bTyp]
  : (super s âˆ— super t â‰£ U)
  â†’ (super (s Ã— t) â‰£ U);

symbol T15 [s : Exp] [U : bTyp]
  : (â„™ (super s) â‰£ U)
  â†’ (super (ğ’« s) â‰£ U);

symbol T15' [s : Exp] [U : bTyp]
  : (U â‰£ â„™ (super s))
  â†’ (U â‰£ super (ğ’« s))
  â‰” Î» h, symm (T15 (symm h));

symbol T16 [x : Var] [s : Exp] [P : Prd] [U : bTyp]
  : âœ“ (âˆ€ x (x âˆˆ s â‡’ P))
  â†’ (super s â‰£ U)
  â†’ (super (comp x (x âˆˆ s âˆ§ P)) â‰£ U);

symbol T17 [I : String] [U : bTyp]
  : given (#id I)
  â†’ (iden I â‰£ U)
  â†’ (super (#id I) â‰£ U);

symbol T17' [I : String] [U : bTyp]
  (h1 : given (#id I))
  (h2 : U â‰£ iden I)
  : (U â‰£ super (#id I))
  â‰” symm (T17 h1 (symm h2));

symbol T18 [s : Exp] [U : bTyp]
  : (super s â‰£ â„™ U)
  â†’ (super (choice s) â‰£ U);

symbol T19 [T U : bTyp]
  : (T â‰£ U)
  â†’ (â„™ T â‰£ â„™ U);

symbol T20 [T U V W : bTyp]
  : (T â‰£ U)
  â†’ (V â‰£ W)
  â†’ (T âˆ— V â‰£ U âˆ— W);

symbol T21 [I : String]
  : given (#id I)
  â†’ (iden I â‰£ iden I);

//// example of a type-checking derivation.
//symbol tc_example
//  (h : given (#id "s"))
//  :
//  let a : Var â‰” id "a" in
//  let b : Var â‰” id "b" in
//  let x : Var â‰” id "x" in
//  let y : Var â‰” id "y" in
//  let s : Exp â‰” #id "s" in
//  âœ“ (âˆ€ (a â¨¾ b) (
//    ((a â†¦ b) âˆˆ ((ğ’« s) Ã— (ğ’« s)))
//    â‡’ (comp x (x âˆˆ s âˆ§ (x âˆˆ a âˆ§ x âˆˆ b)) âŠ† s))
//  )
//  â‰”
//  begin
//    assume h;
//    apply T5;
//    apply T4; assume a;
//    apply T4; assume b;
//    apply T8';
//    apply T17' h;
//    apply T16
//    {
//      apply T4; assume x;
//      apply T1
//      {
//        apply T8; apply T13' a;
//        apply T15'; apply T19;
//        apply T17' h; apply T9 x;
//        apply T17 h; apply T21 h;
//      } {
//        apply T8; apply T13' b;
//        apply T15'; apply T19;
//        apply T17' h; apply T9 x;
//        apply T17 h; apply T21 h;
//      }
//    }{
//      apply T17 h;
//      apply T21 h;
//    }
//  end;

//type tc_example;
